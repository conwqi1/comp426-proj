<?php
require_once ("../config/db.php");
require_once ("../classes/Database.class.php");

function generateURL($root, $term, $zip, $token, $limit)
{
    return $root . "?term=" . $term . "&location=" . $zip . "&ywsid=" . $token . "&limit=" . $limit;
}

function fetch_data($url)
{
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	$data = curl_exec($ch);
	curl_close($ch);
	return $data;
}

function insert_data($json_data, $db)
{
	$data = json_decode($json_data, TRUE);
	$businesses = $data["businesses"];
	$size = count($businesses);
	for($i = 0; $i < $size; $i++){
	  $business = $businesses[$i];

	  $rating = $business["avg_rating"];

	  $address = $business["address1"];
	  $address2 = $business["address2"];
	  $address3 = $business["address3"];
	  if($address2 != "") $address .= " ". $address2;
	  if($address3 != "") $address.= " ". $address3;

	  $city = $business["city"];

	  $state = $business["state_code"];

	  $phone_raw = $business["phone"];
	  $phone = "(" . substr($phone_raw, 0, 3) . ")" . substr($phone_raw, 3, 3) . "-" . substr($phone_raw, 6, 4);
	  if($phone_raw == "") $phone = "N/A";

	  $name = $business["name"];

	  $url = $business["url"];

	  
	  $query = "INSERT INTO `brewery_finder`.`brewery` (`brewery_name`, `brewery_phone`, `brewery_rating`, `city_name`, `state_name`, `brewery_address`, `brewery_url`) 
	  VALUES (" . "'" . $name . "','". $phone . "'," . $rating . ",'" .$city  . "','". $state . "','". $address . "','". $url . "')";

      $status = $db->execQuery($query);
      if($status)
      {
      	print("success" . "<br>");
      }
	}
	return $businesses;
}

//$zipcodes = array('67276', '01936', '22160', '01934', '73019', '01939', '33730', '31908', '46624', '95624', '93706', '92553', '89387', '80221', '65801', '60607', '85302', '94612', '77201', '63155', '23320', '93380', '00016', '00017', '00014', '00015', '91362', '00013', '70509', '00011', '37043', '92711', '91205', '76161', '35203', '23607', '48104', '08549', '32301', '40231', '96820', '91910', '48233', '80525', '49501', '75006', '07208', '92401', '02205', '30901', '93277', '23670', '75149', '01853', '60355', '06101', '23450', '91761', '80030', '95208', '07510', '10017', '94801', '91769', '37421', '40511', '07752', '10199', '36119', '33630', '91355', '97208', '85251', '92647', '93534', '80004', '53203', '09007', '55109', '48502', '76201', '09317', '31402', '92803', '61125', '06982', '27701', '91103', '29201', '95050', '16410', '43216', '89015', '95402', '60505', '95350', '79120', '61601', '94509', '78710', '14692', '48090', '80202', '14519', '01086', '01084', '91505', '36601', '30608', '13220', '08300', '98009', '33152', '99201', '45225', '14461', '54303', '98108', '86738', '10701', '98668', '92834', '27420', '07302', '18101', '48924', '76702', '21202', '40001', '23707', '52401', '98413', '64052', '77501', '92335', '92863', '37230', '85026', '08738', '02014', '70113', '95101', '92507', '09336', '45401', '00049', '92628', '90650', '90301', '43601', '92025', '00043', '09085', '00045', '00044', '00047', '00046', '07102', '07625', '75051', '76541', '64108', '46802', '30304', '23232', '66603', '00020', '27511', '74107', '94015', '78520', '90802', '62703', '89030', '02139', '68108', '80903', '76004', '95661', '01104', '01101', '85225', '27613', '94520', '99599', '71102', '92619', '57104', '90581', '00059', '78041', '91734', '23702', '92054', '55401', '90052', '91793', '79604', '73125', '33060', '72202', '06702', '75040', '33310', '17353', '46206', '65686', '94537', '19104', '75061', '94533', '93907', '01613', '79910', '79402', '90241', '32802', '28302', '00060', '08840', '93065', '08844', '15290', '95813', '48311', '85296', '47708', '97309', '78284', '84199', '91729', '92199', '08756', '66204', '89199', '60540', '02904', '07645', '20090', '60436', '32601', '81003', '75074', '94544', '14240', '01045', '94704', '78501', '85726', '29889', '33075', '39205', '83708', '28228', '27102', '89510', '85201', '66051', '87101', '37950', '85282', '91718', '22314', '53714', '35813', '35078', '44101', '06904', '06602', '97401', '94590', '70826', '85381', '94188', '50941', '32203', '23501', '33909', '94086', '33010', '06511', '93030', '34952', '44309', '50318', '03103', '29401', '78469', '90503', '33024', '38101', '90098', '77707', '92842', '33990', '75260', '93550', '26260', '66106', '68501', '80017', '16515', '93001', '33023', '33022');
$zipcodes = array('27514');
$db = new Database();

for($i = 0; $i < count($zipcodes); $i++)
{
    $url = generateURL("http://api.yelp.com/business_review_search", "breweries", $zipcodes[$i], "HKqtH-cM8ZEcMI9c-0cXhA", 20);
    $data = fetch_data($url);
    insert_data($data, $db);
}

?>